<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CB11 POKER - Real Texas Hold'em</title>
    <style>
        :root { --poker-green: #1a4a32; --gold: #ffd700; --felt: #2d6a4f; --active: #e74c3c; }
        body { background: #121212; color: white; font-family: sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; overflow: hidden;}
        
        #poker-table { 
            width: 85vw; height: 45vh; max-width: 650px; 
            background: radial-gradient(circle, var(--felt) 0%, #1b4332 100%); 
            border: 10px solid #3d2b1f; border-radius: 200px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.6), inset 0 0 30px rgba(0,0,0,0.5); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; 
        }

        #status-area { position: absolute; top: 15px; color: var(--gold); font-size: 14px; text-align: center; width: 90%; z-index: 10; font-weight: bold;}
        #pot-display { font-size: 2.5rem; color: var(--gold); font-weight: bold; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);}
        
        #community-cards { display: flex; gap: 8px; min-height: 60px; }
        .card { background: white; color: black; padding: 10px 15px; border-radius: 6px; font-size: 20px; font-weight: bold; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); display: inline-block;}
        .card.red { color: #d32f2f; }
        .card.hidden { background: #555; color: #555; border: 1px solid #777; }

        #players-ring { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        .player-card { 
            position: absolute; background: rgba(0,0,0,0.85); border: 2px solid #555; 
            padding: 10px; border-radius: 12px; width: 90px; text-align: center; pointer-events: auto;
            transition: all 0.3s;
        }
        /* 当前回合发光特效 */
        .player-card.active-turn { border-color: var(--active); box-shadow: 0 0 15px var(--active); transform: scale(1.1); }
        .player-card.folded { opacity: 0.4; }

        /* 玩家操作区 */
        #action-bar { margin-top: 30px; display: flex; gap: 15px; height: 50px; align-items: center;}
        .btn { padding: 12px 25px; font-size: 1rem; cursor: pointer; border: none; border-radius: 50px; font-weight: bold; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.3);}
        .btn:active { transform: scale(0.95); }
        .btn-fold { background: #555; color: white; }
        .btn-check { background: #3498db; color: white; }
        .btn-raise { background: var(--gold); color: black; }
        .btn-host { background: #9b59b6; color: white; } /* 房主控制面板 */
        
        #center-start-btn { position: absolute; z-index: 50; padding: 15px 40px; font-size: 1.2rem; background: #e74c3c; color: white; border: none; border-radius: 50px; cursor: pointer; }
    </style>
</head>
<body>

<div id="status-area">系统初始化中...</div>

<div id="poker-table">
    <div style="color: rgba(255,255,255,0.5); font-size: 12px; letter-spacing: 2px;">POT</div>
    <div id="pot-display">$0</div>
    <div id="community-cards"></div>
    <button id="center-start-btn" disabled>寻找服务器...</button>
</div>

<div id="players-ring"></div>

<div id="action-bar">
    </div>

<script type="module">
    import * as PK from "https://cdn.skypack.dev/playroomkit";

    // 1. 引擎启动
    const startBtn = document.getElementById("center-start-btn");
    startBtn.innerText = "点击加入牌局";
    startBtn.style.background = "#27ae60";
    startBtn.disabled = false;

    startBtn.onclick = async function() {
        startBtn.style.display = "none";
        try {
            await PK.insertCoin({ gameId: "real_texas_v1", skipLobby: false });
            setupGame();
        } catch (e) {
            alert("连接失败: " + e.message);
            startBtn.style.display = "inline-block";
        }
    };

    function setupGame() {
        // 每秒运行 5 次游戏循环，刷新画面
        setInterval(gameLoop, 200);
        
        // 新玩家加入时，给予初始筹码
        PK.onPlayerJoin((player) => {
            if (player.getState("chips") === undefined) {
                player.setState("chips", 10000, true);
                player.setState("folded", false, true);
            }
        });
    }

    // --- 游戏核心逻辑 ---
    
    // 生成洗好的牌
    function generateDeck() {
        const suits = ['♠', '♥', '♣', '♦'];
        const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        let deck = [];
        for (let s of suits) { for (let v of values) { deck.push({s, v}); } }
        return deck.sort(() => Math.random() - 0.5);
    }

    // 房主控制：开始新一局
    window.hostStartHand = () => {
        if (!PK.isHost()) return;
        
        let deck = generateDeck();
        const players = PK.getPlayers();
        
        // 重置所有人状态并下发底牌
        players.forEach(p => {
            p.setState("folded", false, true);
            p.setState("currentBet", 0, true);
            p.setState("hand", [deck.pop(), deck.pop()], true); // 发两张
        });

        // 设置全桌状态
        PK.setState("deck", deck, true);
        PK.setState("board", [], true); // 公共牌清空
        PK.setState("pot", 0, true);
        PK.setState("phase", "PRE-FLOP", true);
        PK.setState("turnIndex", 0, true); // 从第0个玩家开始行动
    };

    // 房主控制：发公共牌 (推动阶段)
    window.hostNextPhase = () => {
        if (!PK.isHost()) return;
        let phase = PK.getState("phase");
        let board = PK.getState("board") || [];
        let deck = PK.getState("deck") || [];

        if (phase === "PRE-FLOP") {
            board.push(deck.pop(), deck.pop(), deck.pop()); // 发翻牌 3张
            PK.setState("phase", "FLOP", true);
        } else if (phase === "FLOP") {
            board.push(deck.pop()); // 发转牌 1张
            PK.setState("phase", "TURN", true);
        } else if (phase === "TURN") {
            board.push(deck.pop()); // 发河牌 1张
            PK.setState("phase", "RIVER", true);
        } else if (phase === "RIVER") {
            PK.setState("phase", "SHOWDOWN", true); // 摊牌比大小
        }
        
        PK.setState("board", board, true);
        PK.setState("deck", deck, true);
        
        // 新阶段开始，回合回到第0个人
        PK.setState("turnIndex", 0, true); 
    };

    // 玩家行动：弃牌
    window.playerFold = () => {
        const me = PK.myPlayer();
        me.setState("folded", true, true);
        advanceTurn();
    };

    // 玩家行动：过牌/跟注
    window.playerCheckCall = () => {
        advanceTurn();
    };

    // 玩家行动：加注
    window.playerRaise = () => {
        const me = PK.myPlayer();
        const betAmount = 100; // 暂时固定加注100
        let chips = me.getState("chips") || 0;
        let pot = PK.getState("pot") || 0;
        
        if (chips >= betAmount) {
            me.setState("chips", chips - betAmount, true);
            PK.setState("pot", pot + betAmount, true);
            advanceTurn();
        } else {
            alert("筹码不足！");
        }
    };

    // 推进到下一个人
    function advanceTurn() {
        const players = PK.getPlayers();
        let currentIndex = PK.getState("turnIndex") || 0;
        
        // 寻找下一个没有弃牌的玩家
        let nextIndex = (currentIndex + 1) % players.length;
        let loopCount = 0;
        while (players[nextIndex].getState("folded") && loopCount < players.length) {
            nextIndex = (nextIndex + 1) % players.length;
            loopCount++;
        }
        
        PK.setState("turnIndex", nextIndex, true);
    }

    // --- 界面渲染引擎 ---
    let lastRenderState = "";

    function gameLoop() {
        if (!PK) return;
        const me = PK.myPlayer();
        if (!me) return;

        const players = PK.getPlayers();
        const phase = PK.getState("phase") || "WAITING";
        const pot = PK.getState("pot") || 0;
        const turnIndex = PK.getState("turnIndex") || 0;
        const board = PK.getState("board") || [];

        // 1. 更新顶部状态和底池
        document.getElementById("status-area").innerText = `当前阶段: ${phase}`;
        document.getElementById("pot-display").innerText = `$${pot}`;

        // 2. 渲染公共牌
        const boardHtml = board.map(c => {
            const isRed = c.s === '♥' || c.s === '♦';
            return `<div class="card ${isRed?'red':''}">${c.v}${c.s}</div>`;
        }).join("");
        document.getElementById("community-cards").innerHTML = boardHtml;

        // 3. 渲染操作按钮 (核心逻辑)
        let actionHtml = "";
        
        // 房主专属控制面板 (保持在最左边)
        if (PK.isHost()) {
            if (phase === "WAITING" || phase === "SHOWDOWN") {
                actionHtml += `<button class="btn btn-host" onclick="hostStartHand()">▶ 开始新一局</button>`;
            } else {
                actionHtml += `<button class="btn btn-host" onclick="hostNextPhase()">▶ 发公共牌 (推动阶段)</button>`;
            }
        }

        // 玩家自己的回合面板
        const activePlayer = players[turnIndex];
        const isMyTurn = (activePlayer && activePlayer.id === me.id) && phase !== "WAITING" && phase !== "SHOWDOWN";
        
        if (isMyTurn && !me.getState("folded")) {
            actionHtml += `
                <button class="btn btn-fold" onclick="playerFold()">弃牌 Fold</button>
                <button class="btn btn-check" onclick="playerCheckCall()">过牌/跟注 Check</button>
                <button class="btn btn-raise" onclick="playerRaise()">加注 $100</button>
            `;
        } else if (phase !== "WAITING" && phase !== "SHOWDOWN") {
            const activeName = activePlayer ? activePlayer.getProfile().name : "...";
            actionHtml += `<div style="color:#aaa;">等待 ${activeName} 行动...</div>`;
        }
        
        document.getElementById("action-bar").innerHTML = actionHtml;

        // 4. 渲染玩家环绕
        let ringHtml = "";
        players.forEach((p, i) => {
            const prof = p.getProfile();
            const hand = p.getState("hand") || [];
            const chips = p.getState("chips") || 0;
            const folded = p.getState("folded") || false;
            
            const isMe = p.id === me.id;
            const isActive = (i === turnIndex) && (phase !== "WAITING" && phase !== "SHOWDOWN");

            const angle = (i / players.length) * Math.PI * 2 + Math.PI/2;
            const x = Math.cos(angle) * 160 + (window.innerWidth / 2) - 45;
            const y = Math.sin(angle) * 120 + (window.innerHeight / 2) - 40;

            // 牌面显示：自己看正面，别人如果是Showdown阶段看正面，否则看背面
            let cardsHtml = hand.map(c => {
                if (isMe || phase === "SHOWDOWN") {
                    const isRed = c.s === '♥' || c.s === '♦';
                    return `<span class="card-font" style="color:${isRed?'red':'black'}; font-size:14px;">${c.v}${c.s}</span>`;
                }
                return `<span class="card-font hidden" style="font-size:14px;">??</span>`;
            }).join("");
            
            if (folded) cardsHtml = "<span style='color:red; font-size:12px;'>已弃牌</span>";

            ringHtml += `
                <div class="player-card ${isActive ? 'active-turn' : ''} ${folded ? 'folded' : ''}" 
                     style="left:${x}px; top:${y}px; border-color:${prof.color};">
                    <div style="color:${prof.color}; font-size:11px; white-space:nowrap; overflow:hidden;">${prof.name}</div>
                    <div style="color:var(--gold); font-size:12px; margin:3px 0;">$${chips}</div>
                    <div style="display:flex; justify-content:center;">${cardsHtml || '<span style="color:#666; font-size:10px;">未发牌</span>'}</div>
                </div>
            `;
        });

        // 比对渲染锁
        if (ringHtml !== lastRenderState) {
            document.getElementById("players-ring").innerHTML = ringHtml;
            lastRenderState = ringHtml;
        }
    }
</script>
</body>
</html>
