<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CB POKER - Pro Table</title>
    <style>
        :root { --poker-green: #1a4a32; --gold: #ffd700; --bg: #121212; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; }
        
        /* 牌桌样式 */
        #table { 
            width: 90vw; height: 50vh; max-width: 700px; 
            background: radial-gradient(circle, #2d6a4f 0%, #1b4332 100%); 
            border: 12px solid #3d2b1f; border-radius: 200px; 
            position: relative; margin-top: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .pot-box { color: var(--gold); font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .community-cards { display: flex; gap: 8px; min-height: 80px; }
        
        /* 玩家头像框 */
        .player {
            position: absolute; background: rgba(0,0,0,0.8); border: 2px solid #555;
            padding: 10px; border-radius: 12px; width: 100px; text-align: center;
        }
        .player.active { border-color: #e74c3c; box-shadow: 0 0 15px #e74c3c; }

        /* 扑克牌样式 */
        .card-ui { background: white; color: black; padding: 5px 8px; border-radius: 5px; font-weight: bold; font-size: 14px; margin: 2px; }
        .card-ui.red { color: red; }

        .controls { margin-top: 40px; display: flex; gap: 10px; }
        button { padding: 12px 24px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; }
        .btn-main { background: var(--gold); color: black; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="lobby" style="padding-top: 100px; text-align: center;">
        <h1 style="color:var(--gold)">CB POKER</h1>
        <button class="btn-main" onclick="initRoom()">创建/进入房间</button>
    </div>

    <div id="game-container" class="hidden">
        <div id="table">
            <div class="pot-box">POT: $<span id="pot-val">0</span></div>
            <div class="community-cards" id="board"></div>
            <div id="players-ring"></div>
        </div>

        <div class="controls" id="action-btns">
            </div>
    </div>

<script>
    const BACKEND_URL = "https://poker-server.zxc717209554.workers.dev";
    let ws, myName, roomId = new URLSearchParams(window.location.search).get("room");

    async function initRoom() {
        if (!roomId) {
            const res = await fetch(`${BACKEND_URL}/create-room`, { method: "POST" });
            const data = await res.json();
            roomId = data.roomId;
            window.history.pushState({}, "", `?room=${roomId}`);
        }
        
        myName = prompt("请输入你的名字") || "玩家" + Math.floor(Math.random()*1000);
        connect();
    }

    function connect() {
        ws = new WebSocket(BACKEND_URL.replace("https://", "wss://") + `?roomId=${roomId}`);
        ws.onopen = () => {
            ws.send(JSON.stringify({ type: "JOIN", name: myName }));
            document.getElementById("lobby").classList.add("hidden");
            document.getElementById("game-container").classList.remove("hidden");
        };
        ws.onmessage = (e) => render(JSON.parse(e.data));
    }

    function render(state) {
        document.getElementById("pot-val").innerText = state.game.pot;
        
        // 渲染玩家
        const ring = document.getElementById("players-ring");
        ring.innerHTML = "";
        state.players.forEach((p, i) => {
            const isActive = i === state.game.turnIndex && state.status !== "WAITING";
            const angle = (i / state.players.length) * Math.PI * 2 + Math.PI/2;
            const x = Math.cos(angle) * 180 + (window.innerWidth / 2) - 50;
            const y = Math.sin(angle) * 120 + 200; // 粗略调整位置

            const handHtml = p.hand.map(c => {
                const isRed = c.includes('♥') || c.includes('♦');
                return `<span class="card-ui ${isRed?'red':''}">${c}</span>`;
            }).join("");

            ring.innerHTML += `
                <div class="player ${isActive?'active':''}" style="left:${x}px; top:${y}px">
                    <div style="font-size:12px">${p.name}</div>
                    <div style="color:var(--gold); font-size:14px">$${p.chips}</div>
                    <div style="margin-top:5px">${handHtml || '...'}</div>
                </div>
            `;
        });

        // 渲染按钮
        const btns = document.getElementById("action-btns");
        if (state.status === "WAITING") {
            btns.innerHTML = `<button class="btn-main" onclick="send({type:'START_GAME'})">开始这一局</button>`;
        } else {
            const isMyTurn = state.players[state.game.turnIndex].name === myName;
            btns.innerHTML = isMyTurn ? `
                <button style="background:#555;color:white" onclick="send({type:'BET', amount:0})">过牌 Check</button>
                <button class="btn-main" onclick="send({type:'BET', amount:100})">加注 $100</button>
            ` : `<div style="color:#888">等待对手行动...</div>`;
        }
    }

    function send(obj) { ws.send(JSON.stringify(obj)); }
</script>
</body>
</html>
