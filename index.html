<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CB POKER - Game Logic</title>
    <style>
        :root { --poker-green: #1a4a32; --gold: #ffd700; --felt: #2d6a4f; }
        body { background: #121212; color: white; font-family: sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; overflow: hidden;}
        
        #poker-table { 
            width: 85vw; height: 45vh; max-width: 650px; 
            background: radial-gradient(circle, var(--felt) 0%, #1b4332 100%); 
            border: 10px solid #3d2b1f; border-radius: 200px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; 
        }

        #status-area { position: absolute; top: 20px; color: var(--gold); font-size: 14px; text-align: center; width: 90%; z-index: 10;}
        #pot-display { font-size: 2.5rem; color: var(--gold); font-weight: bold; margin-bottom: 10px; }
        
        /* 公共牌显示区 */
        #community-cards { display: flex; gap: 10px; min-height: 60px; align-items: center; justify-content: center; }
        
        #players-ring { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        .player-card { 
            position: absolute; background: rgba(0,0,0,0.9); border: 2px solid #555; 
            padding: 8px; border-radius: 12px; width: 90px; text-align: center; pointer-events: auto;
        }

        .card-font { font-size: 18px; font-weight: bold; background: white; color: black; padding: 4px 8px; border-radius: 6px; margin: 0 2px; box-shadow: 1px 1px 3px rgba(0,0,0,0.5);}
        .card-font.large { font-size: 24px; padding: 10px 15px; border-radius: 8px;}
        
        .controls { margin-top: 30px; display: flex; gap: 15px; z-index: 10; }
        button { padding: 12px 25px; font-size: 1rem; cursor: pointer; border: none; border-radius: 50px; background: var(--gold); color: #000; font-weight: bold; transition: 0.2s;}
        button:disabled { background: #444; color: #888; }
        button:active { transform: scale(0.95); }
        
        #center-start-btn { position: absolute; z-index: 50; padding: 15px 40px; font-size: 1.2rem; background: #e74c3c; color: white; border: none; border-radius: 50px; cursor: pointer; }
    </style>
</head>
<body>

<div id="status-area">房间准备中...</div>

<div id="poker-table">
    <div style="color: rgba(255,255,255,0.4); font-size: 12px; letter-spacing: 2px;">TOTAL POT</div>
    <div id="pot-display">$0</div>
    
    <div id="community-cards"></div>
    
    <button id="center-start-btn" disabled>引擎加载中...</button>
</div>

<div id="players-ring"></div>

<div class="controls">
    <button onclick="window.makeBet(100)">下注 $100</button>
    <button id="deal-btn" onclick="window.advanceGame()">开始发牌</button>
</div>

<script type="module">
    const sources = ["https://cdn.skypack.dev/playroomkit", "https://esm.run/playroomkit", "https://cdn.jsdelivr.net/npm/playroomkit/dist/playroomkit.js"];
    let PK = null;

    async function loadEngine() {
        const startBtn = document.getElementById("center-start-btn");
        const promises = sources.map(src => import(src).then(module => module.default || module));
        try {
            PK = await Promise.any(promises);
            if (PK && PK.insertCoin) {
                startBtn.innerText = "点击加入牌局";
                startBtn.style.background = "#27ae60";
                startBtn.disabled = false;
                startBtn.onclick = window.startPlayroom;
            }
        } catch (e) { startBtn.innerText = "加载失败"; }
    }

    window.startPlayroom = async function() {
        const startBtn = document.getElementById("center-start-btn");
        startBtn.style.display = "none"; 
        try {
            await PK.insertCoin({ gameId: "cb_poker_game_v1", skipLobby: false });
            document.getElementById("status-area").innerHTML = `邀请链接: <span style="color:var(--gold);font-size:12px;">${window.location.href}</span>`;
            setupGame();
        } catch (e) {
            alert("启动失败: " + e.message);
            startBtn.style.display = "inline-block";
        }
    };

    function setupGame() {
        setInterval(gameLoop, 200); // 启动帧循环
    }

    // --- 核心游戏逻辑 ---
    function createDeck() {
        let deck = [];
        const suits = ['♠', '♥', '♣', '♦'];
        const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        suits.forEach(s => values.forEach(v => deck.push(v + s)));
        return deck.sort(() => Math.random() - 0.5); // 洗牌
    }

    // 推动游戏阶段的主控函数 (仅房主可用)
    window.advanceGame = () => {
        if (!PK.isHost()) return;
        
        let phase = PK.getState("phase") || 0;
        let deck = PK.getState("deck") || [];
        let board = PK.getState("board") || [];

        if (phase === 0) {
            // 阶段 1：发底牌 (Pre-flop)
            deck = createDeck();
            const players = PK.getPlayers();
            players.forEach(p => p.setState("hand", [deck.pop(), deck.pop()]));
            PK.setState("board", []);
            PK.setState("pot", 0);
            PK.setState("phase", 1);
        } else if (phase === 1) {
            // 阶段 2：发翻牌 (Flop) - 3张
            board = [deck.pop(), deck.pop(), deck.pop()];
            PK.setState("board", board);
            PK.setState("phase", 2);
        } else if (phase === 2 || phase === 3) {
            // 阶段 3 & 4：发转牌 (Turn) / 发河牌 (River) - 各1张
            board.push(deck.pop());
            PK.setState("board", board);
            PK.setState("phase", phase + 1);
        } else {
            // 阶段 5：清空重置，准备下一局
            PK.setState("phase", 0);
            PK.setState("board", []);
            PK.getPlayers().forEach(p => p.setState("hand", []));
        }
        
        PK.setState("deck", deck); // 保存剩下的牌堆
    };

    window.makeBet = (amount) => {
        const current = PK.getState("pot") || 0;
        PK.setState("pot", current + amount, true);
    };

    // --- 渲染逻辑 ---
    let lastUIState = ""; 

    function gameLoop() {
        // 1. 同步桌面底池
        document.getElementById("pot-display").innerText = `$${PK.getState("pot") || 0}`;

        // 2. 同步房主按钮文字
        const dealBtn = document.getElementById("deal-btn");
        if (!PK.isHost()) {
            dealBtn.disabled = true;
            dealBtn.innerText = "等待房主操作";
        } else {
            dealBtn.disabled = false;
            const phase = PK.getState("phase") || 0;
            const btnTexts = ["发底牌 (Pre-Flop)", "发翻牌 (Flop)", "发转牌 (Turn)", "发河牌 (River)", "重新开始"];
            dealBtn.innerText = btnTexts[phase];
        }

        // 3. 渲染公共牌 (Community Cards)
        const boardCards = PK.getState("board") || [];
        const boardHtml = boardCards.map(card => {
            const isRed = card.includes('♥') || card.includes('♦');
            return `<div class="card-font large" style="color:${isRed?'red':'black'}">${card}</div>`;
        }).join("");
        document.getElementById("community-cards").innerHTML = boardHtml;

        // 4. 渲染玩家位置与手牌
        const players = PK.getPlayers();
        const me = PK.myPlayer();
        let newHTML = "";

        players.forEach((p, i) => {
            const prof = p.getProfile();
            const hand = p.getState("hand") || [];
            const isMe = p.id === me.id;

            const angle = (i / players.length) * Math.PI * 2 + Math.PI/2;
            const x = Math.cos(angle) * 160 + (window.innerWidth / 2) - 45;
            const y = Math.sin(angle) * 120 + (window.innerHeight / 2) - 40;

            const cardsHtml = hand.map(card => {
                if (isMe) {
                    const isRed = card.includes('♥') || card.includes('♦');
                    return `<span class="card-font" style="color:${isRed?'red':'black'}">${card}</span>`;
                }
                return `<span class="card-font" style="background:#555; color:#555; border:1px solid #999">??</span>`;
            }).join("");

            newHTML += `
                <div class="player-card" style="left:${x}px; top:${y}px; border-color:${prof.color};">
                    <div style="color:${prof.color}; font-size:10px;">${prof.name} ${isMe?'(你)':''}</div>
                    <div style="margin-top:5px; display:flex; justify-content:center;">${cardsHtml || '<span style="color:#666; font-size:10px;">未发牌</span>'}</div>
                </div>
            `;
        });

        if (newHTML !== lastUIState) {
            document.getElementById("players-ring").innerHTML = newHTML;
            lastUIState = newHTML;
        }
    }

    loadEngine();
</script>
</body>
</html>
