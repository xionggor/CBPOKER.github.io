<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CB POKER - Multiplayer</title>
    <style>
        :root { --poker-green: #1a4a32; --gold: #ffd700; --felt: #2d6a4f; }
        body { background: #121212; color: white; font-family: sans-serif; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; }
        
        #poker-table { 
            width: 85vw; height: 45vh; max-width: 650px; 
            background: radial-gradient(circle, var(--felt) 0%, #1b4332 100%); 
            border: 10px solid #3d2b1f; border-radius: 200px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; 
        }

        #status-area { position: absolute; top: 20px; color: var(--gold); font-size: 14px; text-align: center; width: 90%; z-index: 10;}
        #pot-display { font-size: 2.5rem; color: var(--gold); font-weight: bold; }
        
        #players-ring { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        .player-card { 
            position: absolute; background: rgba(0,0,0,0.9); border: 2px solid #555; 
            padding: 8px; border-radius: 12px; width: 90px; text-align: center; pointer-events: auto;
        }

        .card-font { font-size: 18px; font-weight: bold; background: white; color: black; padding: 2px 5px; border-radius: 4px; margin: 0 2px; }
        
        .controls { margin-top: 30px; display: flex; gap: 15px; z-index: 10; }
        button { padding: 12px 25px; font-size: 1rem; cursor: pointer; border: none; border-radius: 50px; background: var(--gold); color: #000; font-weight: bold; }
        button:disabled { background: #444; color: #888; }
        
        /* 启动层 */
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; flex-direction: column; align-items:center; justify-content:center; z-index:1000; }
    </style>
</head>
<body>

<div id="overlay">
    <div id="loading-text" style="color:white; margin-bottom:20px;">正在通过全球 CDN 寻找游戏引擎...</div>
    <button id="start-engine-btn" style="display:none;" onclick="startPlayroom()">点击进入游戏房间</button>
</div>

<div id="status-area">房间准备中...</div>

<div id="poker-table">
    <div style="color: rgba(255,255,255,0.4); font-size: 12px;">POT</div>
    <div id="pot-display">$0</div>
</div>

<div id="players-ring"></div>

<div class="controls">
    <button onclick="makeBet(100)">下注 $100</button>
    <button id="deal-btn" onclick="startDeal()">开始发牌</button>
</div>

<script>
    // 1. 动态注入脚本（最原始但也最防卡死的方法）
    function loadScript(url) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = url;
            script.onload = resolve;
            script.onerror = reject;
            document.body.appendChild(script);
        });
    }

    // 尝试多个源，只要有一个成了就立刻停下
    async function bootEngine() {
        const sources = [
            "https://unpkg.com/playroomkit/dist/playroomkit.js",
            "https://cdn.jsdelivr.net/npm/playroomkit/dist/playroomkit.js"
        ];
        
        const loadingText = document.getElementById("loading-text");
        
        for (let src of sources) {
            try {
                loadingText.innerText = `尝试连接节点...`;
                await loadScript(src);
                
                // 检查全局变量是否出现
                if (typeof Playroom !== 'undefined') {
                    loadingText.style.display = "none";
                    document.getElementById("start-engine-btn").style.display = "inline-block";
                    return; // 成功加载，退出函数
                }
            } catch (e) {
                console.warn("节点连接失败，切换下一个:", src);
            }
        }
        
        loadingText.innerText = "❌ 所有节点连接失败！请尝试关闭广告拦截插件，或切换至手机热点重试。";
    }

    // 2. 解决黑屏挡住选人框的核心逻辑
    async function startPlayroom() {
        // 第一步：不管三七二十一，先撤掉黑布！把屏幕让出来！
        document.getElementById("overlay").style.display = "none";
        document.getElementById("status-area").innerText = "请在弹出的界面选择头像和名字...";
        
        try {
            // 第二步：呼叫选人大厅
            await Playroom.insertCoin({ gameId: "cb_poker_prod_final", skipLobby: false });
            
            // 第三步：选完人后准备就绪
            document.getElementById("status-area").innerHTML = `分享此链接邀请好友: <br><span style="color:gold;font-size:12px;">${window.location.href}</span>`;
            setupGame();
        } catch (e) {
            alert("启动失败: " + e.message);
            // 如果失败了，把黑布盖回来让用户重新点
            document.getElementById("overlay").style.display = "flex";
            document.getElementById("start-engine-btn").innerText = "重试";
        }
    }

    // 3. 游戏逻辑设置
    function setupGame() {
        const dealBtn = document.getElementById("deal-btn");
        if (!Playroom.isHost()) {
            dealBtn.disabled = true;
            dealBtn.innerText = "等待房主发牌";
        }

        Playroom.onPlayerJoin(renderUI);
        Playroom.onStateChange("pot", (val) => {
            document.getElementById("pot-display").innerText = `$${val || 0}`;
        });
        Playroom.onStateChange("gameRound", renderUI);
        renderUI();
    }

    // 洗牌与发牌
    function startDeal() {
        if (!Playroom.isHost()) return;
        
        let deck = [];
        const suits = ['♠', '♥', '♣', '♦'];
        const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        suits.forEach(s => values.forEach(v => deck.push(v + s)));
        deck.sort(() => Math.random() - 0.5);

        const players = Playroom.getPlayers();
        players.forEach(p => {
            p.setState("hand", [deck.pop(), deck.pop()]); 
        });

        const round = Playroom.getState("gameRound") || 0;
        Playroom.setState("gameRound", round + 1, true); 
        Playroom.setState("pot", 0, true); 
    }

    function makeBet(amount) {
        const current = Playroom.getState("pot") || 0;
        Playroom.setState("pot", current + amount, true);
    }

    // UI 渲染引擎
    function renderUI() {
        const players = Playroom.getPlayers();
        const me = Playroom.myPlayer();
        const ring = document.getElementById("players-ring");
        ring.innerHTML = "";

        players.forEach((p, i) => {
            const prof = p.getProfile();
            const hand = p.getState("hand") || [];
            const isMe = p.id === me.id;

            const angle = (i / players.length) * Math.PI * 2 + Math.PI/2;
            const x = Math.cos(angle) * 160 + (window.innerWidth / 2) - 45;
            const y = Math.sin(angle) * 120 + (window.innerHeight / 2) - 40;

            const div = document.createElement("div");
            div.className = "player-card";
            div.style.left = `${x}px`;
            div.style.top = `${y}px`;
            div.style.borderColor = prof.color;

            const cardsHtml = hand.map(card => {
                if (isMe) {
                    const isRed = card.includes('♥') || card.includes('♦');
                    return `<span class="card-font" style="color:${isRed?'red':'black'}">${card}</span>`;
                }
                return `<span class="card-font" style="background:#555; color:#555; border:1px solid #999">??</span>`;
            }).join("");

            div.innerHTML = `
                <div style="color:${prof.color}; font-size:10px;">${prof.name} ${isMe?'(你)':''}</div>
                <div style="margin-top:5px; display:flex; justify-content:center;">${cardsHtml || '<span style="color:#666; font-size:10px;">等待发牌</span>'}</div>
            `;
            ring.appendChild(div);
        });
    }

    // 网页加载完毕后，立刻开始探测引擎
    window.onload = bootEngine;
</script>
</body>
</html>
